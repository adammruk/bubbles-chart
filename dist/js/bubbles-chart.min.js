/*!
  * bubbles-chart : Bubble chart
  * @version v0.0.1
  * @author Maximiliano Báez González <mxbg.py@gmail.com>
  */

function BubbleChart(options){this.config=new ConfigBuilder;for(var attr in options)"format"==attr&&(options.format=d3plus.object.merge(this.config.format,options.format)),this.config[attr]=options[attr];"tree"==this.config.type?this.builder=new TreeBuilder(this.config):this.builder=new BubbleBuilder(this.config)}BubbleChart.prototype.data=function(data){this.builder.data(data)},BubbleChart.prototype.on=function(event,handler){this.builder.event[event]=handler};;
d3.layout.orbit=function(){function _orbitLayout(){return _orbitLayout}function calculateNodes(){function traverseNestedData(_node){var target=childrenAccessor(_node);if(target){var thisPie=d3.layout.pie().value(function(d){return childrenAccessor(d)?4:1}),piedValues=thisPie(target);orbitalRings.push({source:_node,x:_node.x,y:_node.y,r:_node.ring/2});for(var x=0;x<target.length;x++)target[x].angle=(piedValues[x].endAngle-piedValues[x].startAngle)/2+piedValues[x].startAngle,target[x].parent=_node,target[x].depth=_node.depth+1,target[x].x=childrenAccessor(_node)[x].parent.x+target[x].parent.ring/2*Math.sin(target[x].angle),target[x].y=target[x].parent.y+target[x].parent.ring/2*Math.cos(target[x].angle),target[x].x0=target[x].parent.x,target[x].y0=target[x].parent.y,target[x].deltaX=function(_x){return _x},target[x].deltaY=function(_y){return _y},target[x].ring=childrenAccessor(_node)[x].parent.ring/orbitDepthAdjust(_node),flattenedNodes.push(target[x])}}var _data=nestedNodes;childrenAccessor(_data)?orbitNodes=_data:(orbitNodes={key:"root",values:_data},childrenAccessor(orbitNodes).forEach(function(_node){_node.parent=orbitNodes}));orbitNodes.x=orbitSize[0]/2,orbitNodes.y=orbitSize[1]/2,orbitNodes.deltaX=function(_x){return _x},orbitNodes.deltaY=function(_y){return _y},orbitNodes.ring=.75*orbitSize[0],orbitNodes.depth=0,flattenedNodes.push(orbitNodes),traverseNestedData(orbitNodes)}var orbitNodes,nestedNodes,orbitSize=[1,1],flattenedNodes=[],orbitDispatch=d3.dispatch("tick"),orbitalRings=[],orbitDepthAdjust=function(){return 2.95},childrenAccessor=function(d){return d.children};return _orbitLayout.mode=function(){},_orbitLayout.size=function(_value){return arguments.length?(orbitSize=_value,this):orbitSize},_orbitLayout.revolution=function(_function){return arguments.length?(tickRadianFunction=_function,this):tickRadianFunction},_orbitLayout.orbitSize=function(_function){return arguments.length?(orbitDepthAdjust=_function,this):orbitDepthAdjust},_orbitLayout.orbitalRings=function(){return arguments.length?this:orbitalRings},_orbitLayout.nodes=function(_data){return arguments.length?(nestedNodes=_data,calculateNodes(),this):flattenedNodes},_orbitLayout.children=function(_function){return arguments.length?(childrenAccessor=_function,this):childrenAccessor},d3.rebind(_orbitLayout,orbitDispatch,"on"),_orbitLayout};;
function ConfigBuilder(){return{defaultColor:"#ddd",type:"none",sort:!1,percentage:!1,color:d3plus.color.scale,offset:5,padding:30,tooltip:!1,level:0,levels:[],toggle:{title:"",size:!1},wave:{dy:11,count:4},tree:{speed:250},animation:{speed:3e3,method:"no-recursive"},format:{text:function(text,key){return d3plus.string.title(text)},number:function(number,data){return d3plus.number.format(number)}}}};
function BubbleEvents(){this.event={}}BubbleEvents.prototype.trigger=function(name,d){"undefined"!=typeof this.event[name]&&this.event[name](d)};;
function UiBuilder(config){this.config=config}UiBuilder.prototype=new BubbleEvents,UiBuilder.prototype.constructor=UiBuilder,UiBuilder.prototype.prepareContainer=function(){this.diameter=$(this.config.container).height(),this.width=$(this.config.container).width()-this.config.padding,this.diameter=this.diameter<500?500:this.diameter,this.config.scope=this.config.container.replace("#",""),this.vizId=this.config.scope+"-viz",this.footerId=this.config.scope+"-footer";var $viz=$("<div />");$viz.attr("id",this.vizId);var $footer=$("<div />");$footer.attr("id",this.footerId),$(this.config.container).append($viz),$(this.config.container).append($footer),d3.select(self.frameElement).style("height",this.diameter+"px")},UiBuilder.prototype.text=function(node,options){function isLikeWhite(c){var dc=235,rgb=d3.rgb(c);return rgb.r>=dc&&rgb.g>=dc&&rgb.b>=dc}var thiz=this;return node.append("text").attr("class","wrap").style("fill",function(d){var c=thiz.config.color(d[thiz.config.label]);return c=d3plus.color.text(c),isLikeWhite(c)?thiz.config.defaultColor:c}).text(function(d){return thiz.config.format.text(d[thiz.config.label])})},UiBuilder.prototype.circle=function(node,options){var thiz=this;return options="undefined"==typeof options?{}:options,options.offset="undefined"==typeof options.offset?0:options.offset,options["class"]="undefined"==typeof options["class"]?"shape":options["class"],node.append("circle").attr("r",function(d){return d.r<options.offset?0:d.r-options.offset}).attr("class",options["class"]).style("fill",function(d){return"undefined"!=typeof options.fill?options.fill:thiz.config.color(d[thiz.config.label])})},UiBuilder.prototype.createTooltip=function(el,d){var thiz=this,data=[{value:d[thiz.config.size],name:thiz.config.size}];this.config.percentage&&data.push({value:100*this.config.percentage(d),name:"Percentage"}),data=this.config.tooltip?this.config.tooltip(d):data;for(var i=0;i<data.length;i++)data[i].name=thiz.config.format.text(data[i].name),isNaN(data[i].value)?data[i].value=thiz.config.format.text(data[i].value):data[i].value=thiz.config.format.number(data[i].value);var elP=$(el).position(),$el=($("#"+this.vizId).position(),d3.select(el)),bbox=$el.node().getBBox(),maxWidth=(d3.transform($el.attr("transform")).translate,300),maxHeigth=15+35*data.length,toffset=20,x=elP.left+bbox.width/2-maxWidth/2,y=elP.top-maxHeigth-toffset;x=0>x?0:x,y=0>x?0:y;var config={id:thiz.config.scope+"_visualization_focus",x:x,y:y,allColors:!0,fixed:!0,size:"small",color:thiz.config.color(d[thiz.config.label]),fontfamily:"Helvetica Neue",fontweight:200,fontsize:"15px",data:data,width:maxWidth,max_width:maxWidth,mouseevents:!1,arrow:!0,align:"bottom center",anchor:"top left",title:thiz.config.format.text(d[thiz.config.label])};d3plus.tooltip.create(config)},UiBuilder.prototype.wrapText=function(){$("#"+this.vizId).find(".wrap").each(function(){d3plus.textwrap().container(d3.select(this)).resize(!0).align("middle").valign("middle").draw()})},UiBuilder.prototype.breadcrumbs=function(){for(var $ul=$("<ul class='bubble-hierarchies'/>"),$liTmpl=$("<li / >"),$aTmpl=$("<a class='bubble-levels disable'/>"),i=0;i<this.config.levels.length;i++){var $li=$liTmpl.clone(),aId="bubble-li-lvl-"+i,$a=$aTmpl.clone();$a.attr("data-level",i),$a.attr("id",aId),$a.attr("data-name",this.config.levels[i]),$a.text(this.config.levels[i]),$li.append($a),$ul.append($li)}var $ol=$("<ol class='bubble-breadcrumbs' />");$(this.config.container).prepend($ol),$(this.config.container).prepend($ul)},UiBuilder.prototype.drillup=function(){for(var level=this.config.level,$labels=$(this.config.container).find(".bubble-breadcrumbs"),$brumbs=$(this.config.container).find(".bubble-hierarchies"),len=$brumbs.find("[data-level]").length,i=level;len>i;i++){$labels.find("[data-level='"+i+"']").remove();var $aEl=$brumbs.find("[data-level='"+i+"']"),aId=$aEl.attr("id");$aEl.addClass("disable"),$("."+aId).remove()}},UiBuilder.prototype.updateBreadcrumbs=function(d){var fill=this.config.color(d[this.config.label]),textColor=d3plus.color.text(fill),$brumbs=$(this.config.container).find(".bubble-hierarchies"),$a=$brumbs.find("[data-level='"+this.config.level+"']"),aId=$a.attr("id");$a.removeClass("disable");var aStyle="<style class='{id}'>";aStyle+="a#{id}::before {border-color: {fill} {fill} {fill} transparent;}",aStyle+="li:last-child a#{id}::after {border-color: {fill} {fill} {fill} {fill};}",aStyle+="li a#{id}::after {border-left: 1em solid {fill};}",aStyle+="a#{id}{background-color: {fill}; color:{text}}",aStyle+="li:first-child a#{id}::before{border-color: {fill} {fill} {fill} {fill};}",aStyle+="</style>",aStyle=aStyle.replace(/{id}/g,aId).replace(/{fill}/g,fill).replace(/{text}/g,textColor),$a.append($(aStyle));var $labels=$(this.config.container).find(".bubble-breadcrumbs"),$li=$("<li/ >");$li.attr("data-level",this.config.level);var $span=$("<span class='text'/>"),$div=$("<div class='note'/>");$span.text(this.config.format.text(d[this.config.label])),$div.text(this.config.format.number(d[this.config.size])),$li.append($span),$labels.append($li)};;
function BubbleAnimation(config){this.config=config,this.initialize()}BubbleAnimation.prototype.animationTick=function(method,validate,speed){var thiz=this;speed=speed?speed:this.config.animation.speed;var interval=setInterval(function(){var waves=$(".wave");validate(waves.length)?thiz[method]():(console.info("clear - >"+method),clearInterval(interval))},speed)},BubbleAnimation.prototype.initialize=function(){return"recursive"==this.config.method?void this.animate():void this.animationTick("animate",function(l){return l>0},10)},BubbleAnimation.prototype.animateWave=function(wave){var thiz=this;wave.attr("transform",function(d){return"translate("+d.r+")"}),wave.transition().duration(this.config.speed).ease("linear").attr("transform",function(d){return"translate( -"+d.r+")"}).attr("T",1).each("end",function(){wave.attr("T",0),"recursive"==thiz.config.method&&thiz.animateWave(wave)})},BubbleAnimation.prototype.animate=function(){var thiz=this;d3.selectAll("path").filter(function(d){var wave=d3.select(this);return 0==wave.attr("T")}).each(function(d,i){var wave=d3.select(this);wave.attr("T")>0||thiz.animateWave(wave)})};;
function BubbleBuilder(config,ui){this.dataArray=[],this.timeArray=[],this.timeSelection=[],this.config=config,this.initialize()}BubbleBuilder.prototype=new UiBuilder,BubbleBuilder.prototype.constructor=UiBuilder,BubbleBuilder.prototype.initialize=function(options){this.prepareContainer()},BubbleBuilder.prototype.selectable=function(ul,li,update){function isParentNode(parentNode,node){return node?node===parentNode?!0:isParentNode(parentNode,node.parentNode):!1}function selectFirst(selection){selection.each(function(d,i){0===i&&(d._selected=!0)})}function selectLast(selection){selection.each(function(d,i,j){i===selection[j].length-1&&(d._selected=!0)})}function select(d,node){var parentNode=ul.filter(function(){return isParentNode(this,node)}).node(),lis=li.filter(function(){return isParentNode(parentNode,this)});if(d3.event.shiftKey){var firstSelectedIndex,lastSelectedIndex,currentIndex;lis.each(function(dl,i){dl._selected&&(firstSelectedIndex||(firstSelectedIndex=i),lastSelectedIndex=i),this===node&&(currentIndex=i)});var min=Math.min(firstSelectedIndex,lastSelectedIndex,currentIndex),max=Math.max(firstSelectedIndex,lastSelectedIndex,currentIndex);lis.each(function(d,i){d._selected=d3.event.ctrlKey&&d._selected||i>=min&&max>=i})}else d3.event.ctrlKey||lis.each(function(d){d._selected=!1}),d._selected=!d._selected;lastDecision=d._selected,update()}var lastDecision;ul.selectAll("li").on("mousedown",function(d){select(d,this)}).on("mouseover",function(d){d3.event.which&&(d._selected=lastDecision,update())});var keyCodes={up:38,down:40,home:36,end:35,a:65};ul.on("keydown",function(){if(-1!==d3.values(keyCodes).indexOf(d3.event.keyCode)&&(d3.event.keyCode!==keyCodes.a||d3.event.ctrlKey)){var focus=ul.filter(":focus").node();if(focus){d3.event.preventDefault();var scope=li.filter(function(d){return isParentNode(focus,this)}),selecteds=scope.select(function(d){return d._selected});d3.event.ctrlKey||scope.each(function(d){d._selected=!1});var madeSelection=!1;switch(d3.event.keyCode){case keyCodes.up:selecteds.each(function(d,i,j){scope[j][i-1]&&(madeSelection=d3.select(scope[j][i-1]).data()[0]._selected=!0)}),madeSelection||selectLast(scope);break;case keyCodes.down:selecteds.each(function(d,i,j){scope[j][i+1]&&(madeSelection=d3.select(scope[j][i+1]).data()[0]._selected=!0)}),madeSelection||selectFirst(scope);break;case keyCodes.home:selectFirst(scope);break;case keyCodes.end:selectLast(scope);break;case keyCodes.a:scope.each(function(d){d._selected=!d3.event.shiftKey})}update()}}})},BubbleBuilder.prototype.builder=function(data){var thiz=this,bubble=d3.layout.pack().size([this.width,this.diameter]).padding(1.5);this.config.sort&&bubble.sort(function(a,b){return a.value-b.value});var vizId="#"+this.vizId;$(vizId).html("");var svg=d3.select(vizId).append("svg").attr("width",this.width).attr("height",this.diameter).attr("class","bubble"),node=svg.selectAll(".node").data(bubble.nodes(this.buildNodes(data)).filter(function(d){return!d.children})).enter().append("g").attr("class","node").on("click",function(d){thiz.trigger("click",d)}).on("mouseenter",function(d){thiz.trigger("mouseenter",d)}).on("mouseover",function(d){thiz.trigger("mouseover",d),d3.select(this).attr("stroke-width","5px"),thiz.createTooltip(this,d)}).on("mouseout",function(d){thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus")}).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),gnode=node.append("g");this.circle(gnode).style("stroke",function(d){var c=thiz.config.color(d[thiz.config.label]);return d3plus.color.legible(c)});this.config.percentage?(this.circle(gnode,{offset:thiz.config.offset}).style("stroke","#FFF").style("stroke-width","2px"),this.buildGauge(node)):(this.circle(gnode),this.text(gnode)),"liquid"==this.config.type&&(this.animation=new BubbleAnimation(this.config.animation))},BubbleBuilder.prototype.data=function(data){this.dataArray=$.extend([],data,!0),this.builder(data),this.config.time&&this.timeline(),this.config.toggle.size&&this.sizeToggle(),this.wrapText()},BubbleBuilder.prototype.fillPercentage=function(d){if(2*d.r<this.config.offset)return 0;var p=this.config.percentage(d);return p=2*d.r*(1-p),0>p?0:parseInt(p)},BubbleBuilder.prototype.buildWave=function(clip){var thiz=this;clip.append("path").attr("id",function(d){return"g-clip-rect"+d3plus.string.strip(d[thiz.config.label])}).attr("class","path wave").attr("T",0).attr("d",function(d){var p=thiz.fillPercentage(d);if(0==p)return"";for(var x=parseInt(2*-d.r),dx=parseInt(4*d.r/thiz.config.wave.count),b="",y0=p-d.r;x<2*d.r;)b+=" M "+x+" "+y0+" q "+dx/2+" "+thiz.config.wave.dy+" "+dx+" 0",x+=dx;return b+""})},BubbleBuilder.prototype.buildGauge=function(node){var g=node.append("g"),thiz=this,clip=g.append("clipPath").attr("id",function(d){return"g-clip-"+d3plus.string.strip(d[thiz.config.label])});clip.append("rect").attr("id",function(d){return"g-clip-rect"+d3plus.string.strip(d[thiz.config.label])}).attr("y",function(d){return-d.r+thiz.config.offset}).attr("x",function(d){return-d.r+thiz.config.offset}).attr("width",function(d){return 2*d.r<thiz.config.offset?0:2*d.r-thiz.config.offset}).attr("height",function(d){var p=thiz.fillPercentage(d);return p+=thiz.config.offset-thiz.config.wave.dy+1,0>p?0:p}),"liquid"!=this.config.type&&"wave"!=this.config.type||this.buildWave(clip),this.circle(g,{offset:thiz.config.offset,fill:"#FFF"}).attr("clip-path",function(d){var clip=window.location.href;return clip=clip.split("#")[0],clip+="#g-clip-"+d3plus.string.strip(d[thiz.config.label]),"url("+clip+")"}),this.text(g)},BubbleBuilder.prototype.buildNodes=function(data){for(var thiz=this,d=this.groupingData(data),i=0;i<d.length;i++)d[i].value=d[i][thiz.config.size];return{children:d}},BubbleBuilder.prototype.roolup=function(v,sample){var data={},thiz=this;for(var attr in sample)attr==this.config.time?data[attr]=v.map(function(d){return-1==thiz.timeArray.indexOf(d[attr])&&thiz.timeArray.push(d[attr]),d[attr]}):attr==this.config.label?data[attr]=v[0][attr]:"number"==typeof sample[attr]?data[attr]=d3.sum(v,function(d){return d[attr]}):data[attr]=v.map(function(d){return d[attr]});return data},BubbleBuilder.prototype.groupingData=function(data){var thiz=this,sampleObj=null,tmp=data.filter(function(d){return 0==thiz.timeSelection.length||thiz.timeSelection.indexOf(d[thiz.config.time])>=0}),filters=d3.nest().key(function(d){return sampleObj=d,d[thiz.config.label]}).rollup(function(v){return thiz.roolup(v,sampleObj)}).entries(tmp);return filters.map(function(d){return d.values})},BubbleBuilder.prototype.onChange=function(){var data=$.extend([],this.dataArray,!0);this.builder(data),this.wrapText()},BubbleBuilder.prototype.timeline=function(){var ul=d3.select("#"+this.footerId).append("ul").attr("class","timeline").attr("tabindex",1),thiz=this,time=this.timeArray.sort().map(function(d){var data={time:d,_selected:!0};return data}),li=ul.selectAll("li").data(time).enter().append("li").attr("class","entry").classed("selected",function(d){return d._selected}).append("a").text(function(d){return d.time});this.selectable(ul,li,function(e){var selections=[];ul.selectAll("li").classed("selected",function(d){return d._selected&&selections.push(d),d._selected}),thiz.timeSelection=selections.map(function(d){return d.time}),thiz.onChange(),thiz.trigger("timechange",thiz.timeSelection)})},BubbleBuilder.prototype.sizeToggle=function(){var $footer=$("#"+this.footerId),$toogle=$("<div></div>");$toogle.addClass("bubble-toogle"),$toogle.attr("id",this.footerId+"-toogle"),$footer.append($toogle);var thiz=this;d3plus.form().data(this.config.toggle.size).title(this.config.toggle.title).container("#"+this.footerId+"-toogle").id("value").text("text").type("toggle").draw();$footer.find(".d3plus_toggle").on("click",function(d){var $target=$(this)[0],data=$target.__data__;"undefined"!=typeof data&&(thiz.config.size=data.value,thiz.onChange())})};;
function TreeBuilder(config){this.config=config,this.rscale=0,this.initialize()}TreeBuilder.prototype=new UiBuilder,TreeBuilder.prototype.constructor=UiBuilder,TreeBuilder.prototype.prepareData=function(data){var thiz=this;return data[thiz.config.size]=d3.sum(data.children,function(d){return d[thiz.config.size]}),data.max=d3.max(data.children,function(d){return d[thiz.config.size]}),data.min=d3.min(data.children,function(d){return d[thiz.config.size]}),data.min=data.min==data.max?0:data.min,this.rscale=d3.scale.linear().domain([data.min,data.max]).range([0,this.diameter/10]),data},TreeBuilder.prototype.initialize=function(options){this.prepareContainer(),"undefined"!=typeof this.config.levels&&this.breadcrumbs()},TreeBuilder.prototype.data=function(data){var gdata=this.prepareData(data);this.builder(gdata)},TreeBuilder.prototype.circle=function(node){function r(d,offset){offset=offset?offset:0;var r=thiz.rscale(d[thiz.config.size])-offset;return d.max&&(r=1.5*thiz.rscale(d.max)-offset),d.r=r,10>r?10:r}var thiz=this;node.append("circle").attr("class","shape").attr("r",r).style("fill",function(d){return thiz.config.color(d[thiz.config.label])}).style("stroke",function(d){var c=thiz.config.color(d[thiz.config.label]);return d3plus.color.legible(c)}),this.text(node);node.append("circle").attr("class","shape-border").filter(function(d){return!d.parent}).attr("r",function(d){return r(d,5)}).style("fill","transparent").style("stroke","white").style("stroke-dasharray","5,5").style("stroke-width","1px")},TreeBuilder.prototype.builder=function(gdata){var vizId="#"+this.vizId,thiz=this,viz=document.getElementById(this.vizId);viz.innerHTML="",orbitScale=d3.scale.linear().domain([1,3]).range([3.8,1.5]).clamp(!0);var orbit=d3.layout.orbit().size([this.diameter,this.diameter]).children(function(d){return d.children}).revolution(function(d){return d.depth}).orbitSize(function(d){return orbitScale(d.depth)});orbit.nodes(gdata);var nodes=d3.select(vizId).append("svg").selectAll("g.node").data(orbit.nodes()).enter().append("g").attr("class",function(d){var clazz="node";return d.parent||(clazz+=" center"),clazz}).attr("transform",function(d){return d.parent?"translate("+d.x0+","+d.y0+")":"translate("+d.x+","+d.y+")"}).on("mouseover",function(d){thiz.trigger("mouseover",d),d3.select(this).attr("stroke-width","5px"),thiz.createTooltip(this,d)}).on("mouseout",function(d){thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus")}).on("click",function(d){thiz.onClick(d3.select(this),d)});nodes.transition().duration(this.config.tree.speed).ease("linear").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).attr("T",1).each("end",function(){nodes.attr("T",0)}),this.circle(d3.selectAll("g.node")),d3.select("svg").selectAll("circle.orbits").data(orbit.orbitalRings()).enter().insert("circle","g").attr("class","ring").attr("r",function(d){return d.r}).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).style("fill","none").style("stroke","black").style("stroke-dasharray","2,2").style("stroke-width","1px"),this.wrapText()},TreeBuilder.prototype.onClick=function(node,d){function getCleandata(d){var tmp={};return tmp[thiz.config.label]=d[thiz.config.label],tmp[thiz.config.size]=d[thiz.config.size],tmp.children=d.children,tmp._parent=d._parent?d._parent:d.parent,tmp}var thiz=this,$center=d3.select(".node.center"),cr=$center.select("circle.shape").attr("r"),cxy=$center.attr("transform");d.children&&(node.transition().duration(this.config.tree.speed).ease("linear").attr("transform",cxy).attr("T",1).each("end",function(){node.attr("T",0)}),node.select(".shape").transition().duration(this.config.tree.speed).ease("linear").attr("r",cr).attr("T",1).each("end",function(d){node.select(".shape").attr("T",0),d.children&&(d.max?d._parent&&(thiz.config.level-=1,thiz.data(getCleandata(d._parent)),thiz.drillup(d)):(thiz.data(getCleandata(d)),thiz.updateBreadcrumbs(d),thiz.config.level+=1))}))};