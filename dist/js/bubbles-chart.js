/*!
  * bubbles-chart : Bubble chart
  * @version v0.0.1
  * @author Maximiliano Báez González <mxbg.py@gmail.com>
  * @date 2016-06-10
  */

function ConfigBuilder(){return{defaultColor:"#ddd",type:"none",sort:!1,percentage:!1,color:d3plus.color.scale,offset:5,padding:30,tooltip:!1,toggle:{title:"",size:!1},wave:{dy:11,count:4},format:{text:function(text,key){return d3plus.string.title(text)},number:function(number,data){return d3plus.number.format(number)}}}}function BubbleBuilder(options){this.dataArray=[],this.timeArray=[],this.timeSelection=[],this.event={},this.config=new ConfigBuilder,this.initialize(options)}function BubbleChart(options){this.builder=new BubbleBuilder(options)}BubbleBuilder.prototype.trigger=function(name,d){"undefined"!=typeof this.event[name]&&this.event[name](d)},BubbleBuilder.prototype.initialize=function(options){for(var attr in options)"format"==attr&&(options.format=d3plus.object.merge(this.config.format,options.format)),this.config[attr]=options[attr];this.prepareContainer()},BubbleBuilder.prototype.selectable=function(ul,li,update){function isParentNode(parentNode,node){return node?node===parentNode?!0:isParentNode(parentNode,node.parentNode):!1}function selectFirst(selection){selection.each(function(d,i){0===i&&(d._selected=!0)})}function selectLast(selection){selection.each(function(d,i,j){i===selection[j].length-1&&(d._selected=!0)})}function select(d,node){var parentNode=ul.filter(function(){return isParentNode(this,node)}).node(),lis=li.filter(function(){return isParentNode(parentNode,this)});if(d3.event.shiftKey){var firstSelectedIndex,lastSelectedIndex,currentIndex;lis.each(function(dl,i){dl._selected&&(firstSelectedIndex||(firstSelectedIndex=i),lastSelectedIndex=i),this===node&&(currentIndex=i)});var min=Math.min(firstSelectedIndex,lastSelectedIndex,currentIndex),max=Math.max(firstSelectedIndex,lastSelectedIndex,currentIndex);lis.each(function(d,i){d._selected=d3.event.ctrlKey&&d._selected||i>=min&&max>=i})}else d3.event.ctrlKey||lis.each(function(d){d._selected=!1}),d._selected=!d._selected;lastDecision=d._selected,update()}var lastDecision;ul.selectAll("li").on("mousedown",function(d){select(d,this)}).on("mouseover",function(d){d3.event.which&&(d._selected=lastDecision,update())});var keyCodes={up:38,down:40,home:36,end:35,a:65};ul.on("keydown",function(){if(-1!==d3.values(keyCodes).indexOf(d3.event.keyCode)&&(d3.event.keyCode!==keyCodes.a||d3.event.ctrlKey)){var focus=ul.filter(":focus").node();if(focus){d3.event.preventDefault();var scope=li.filter(function(d){return isParentNode(focus,this)}),selecteds=scope.select(function(d){return d._selected});d3.event.ctrlKey||scope.each(function(d){d._selected=!1});var madeSelection=!1;switch(d3.event.keyCode){case keyCodes.up:selecteds.each(function(d,i,j){scope[j][i-1]&&(madeSelection=d3.select(scope[j][i-1]).data()[0]._selected=!0)}),madeSelection||selectLast(scope);break;case keyCodes.down:selecteds.each(function(d,i,j){scope[j][i+1]&&(madeSelection=d3.select(scope[j][i+1]).data()[0]._selected=!0)}),madeSelection||selectFirst(scope);break;case keyCodes.home:selectFirst(scope);break;case keyCodes.end:selectLast(scope);break;case keyCodes.a:scope.each(function(d){d._selected=!d3.event.shiftKey})}update()}}})},BubbleBuilder.prototype.prepareContainer=function(){this.diameter=$(this.config.container).height(),this.width=$(this.config.container).width()-this.config.padding,this.diameter=this.diameter<500?500:this.diameter,this.config.scope=this.config.container.replace("#",""),this.vizId=this.config.scope+"-viz",this.footerId=this.config.scope+"-footer";var $viz=$("<div />");$viz.attr("id",this.vizId);var $footer=$("<div />");$footer.attr("id",this.footerId),$(this.config.container).append($viz),$(this.config.container).append($footer),d3.select(self.frameElement).style("height",this.diameter+"px")},BubbleBuilder.prototype.builder=function(data){var thiz=this,bubble=d3.layout.pack().size([this.width,this.diameter]).padding(1.5);this.config.sort&&bubble.sort(function(a,b){return a.value-b.value});var vizId="#"+this.vizId;$(vizId).html("");var svg=d3.select(vizId).append("svg").attr("width",this.width).attr("height",this.diameter).attr("class","bubble"),node=svg.selectAll(".node").data(bubble.nodes(this.buildNodes(data)).filter(function(d){return!d.children})).enter().append("g").attr("class","node").on("click",function(d){thiz.trigger("click",d)}).on("mouseenter",function(d){thiz.trigger("mouseenter",d)}).on("mouseover",function(d){thiz.trigger("mouseover",d),d3.select(this).attr("stroke-width","5px"),thiz.createTooltip(d)}).on("mouseout",function(d){thiz.trigger("mouseout",d),d3.select(this).attr("stroke-width","1px"),d3plus.tooltip.remove(thiz.config.scope+"_visualization_focus")}).attr("transform",function(d){return"translate("+d.x+","+d.y+")"}),gnode=node.append("g");this.circle(gnode).style("stroke",function(d){var c=thiz.config.color(d[thiz.config.label]);return d3plus.color.legible(c)});this.config.percentage?(this.circle(gnode,{offset:thiz.config.offset}).style("stroke","#FFF").style("stroke-width","2px"),this.buildGauge(node)):(this.circle(gnode),this.text(gnode))},BubbleBuilder.prototype.text=function(node,options){function isLikeWhite(c){var dc=235,rgb=d3.rgb(c);return rgb.r>=dc&&rgb.g>=dc&&rgb.b>=dc}var thiz=this;return node.append("text").attr("class","wrap").style("fill",function(d){var c=thiz.config.color(d[thiz.config.label]);return c=d3plus.color.text(c),isLikeWhite(c)?thiz.config.defaultColor:c}).text(function(d){return thiz.config.format.text(d[thiz.config.label])})},BubbleBuilder.prototype.circle=function(node,options){var thiz=this;return options="undefined"==typeof options?{}:options,options.offset="undefined"==typeof options.offset?0:options.offset,options["class"]="undefined"==typeof options["class"]?"shape":options["class"],node.append("circle").attr("r",function(d){return d.r<options.offset?0:d.r-options.offset}).attr("class",options["class"]).style("fill",function(d){return"undefined"!=typeof options.fill?options.fill:thiz.config.color(d[thiz.config.label])})},BubbleBuilder.prototype.data=function(data){this.dataArray=$.extend([],data,!0),this.builder(data),this.config.time&&this.timeline(),this.config.toggle.size&&this.sizeToggle(),this.wrapText()},BubbleBuilder.prototype.wrapText=function(){$("#"+this.vizId).find(".wrap").each(function(){d3plus.textwrap().container(d3.select(this)).resize(!0).align("middle").valign("middle").draw()})},BubbleBuilder.prototype.animateWave=function(wave){var thiz=this;wave.attr("transform",function(d){return"translate("+d.r+")"}),wave.transition().duration(2e3).ease("linear").attr("transform",function(d){return"translate( -"+d.r+")"}).attr("T",1).each("end",function(){wave.attr("T",0),thiz.animateWave(wave)})},BubbleBuilder.prototype.fillPercentage=function(d){if(2*d.r<this.config.offset)return 0;var p=this.config.percentage(d);return p=2*d.r*(1-p),0>p?0:parseInt(p)},BubbleBuilder.prototype.buildWave=function(clip){var thiz=this,path=clip.append("path").attr("id",function(d){return"g-clip-rect"+d3plus.string.strip(d[thiz.config.label])}).attr("class","path").attr("d",function(d){var p=thiz.fillPercentage(d);if(0==p)return"";for(var x=parseInt(2*-d.r),dx=parseInt(4*d.r/thiz.config.wave.count),b="",y0=p-d.r;x<2*d.r;)b+=" M "+x+" "+y0+" q "+dx/2+" "+thiz.config.wave.dy+" "+dx+" 0",x+=dx;return b+""});"liquid"==this.config.type&&this.animateWave(path)},BubbleBuilder.prototype.buildGauge=function(node){var g=node.append("g"),thiz=this,clip=g.append("clipPath").attr("id",function(d){return"g-clip-"+d3plus.string.strip(d[thiz.config.label])});clip.append("rect").attr("id",function(d){return"g-clip-rect"+d3plus.string.strip(d[thiz.config.label])}).attr("y",function(d){return-d.r+thiz.config.offset}).attr("x",function(d){return-d.r+thiz.config.offset}).attr("width",function(d){return 2*d.r<thiz.config.offset?0:2*d.r-thiz.config.offset}).attr("height",function(d){var p=thiz.fillPercentage(d);return p+=thiz.config.offset-thiz.config.wave.dy+1,0>p?0:p}),"liquid"!=this.config.type&&"wave"!=this.config.type||this.buildWave(clip),this.circle(g,{offset:thiz.config.offset,fill:"#FFF"}).attr("clip-path",function(d){var clip=window.location.href;return clip+="#g-clip-"+d3plus.string.strip(d[thiz.config.label]),"url("+clip+")"}),this.text(g)},BubbleBuilder.prototype.createTooltip=function(d){var thiz=this,data=[{value:d[thiz.config.size],name:thiz.config.size}];this.config.percentage&&data.push({value:100*this.config.percentage(d),name:"Percentage"}),data=this.config.tooltip?this.config.tooltip(d):data;for(var i=0;i<data.length;i++)data[i].name=thiz.config.format.text(data[i].name),isNaN(data[i].value)?data[i].value=thiz.config.format.text(data[i].value):data[i].value=thiz.config.format.number(data[i].value);var maxWidth=300,maxHeigth=15+35*data.length,x=d3.event.clientX-maxWidth/2,y=d3.event.clientY-maxHeigth;x=0>x?0:x,y=0>x?0:y;var config={id:thiz.config.scope+"_visualization_focus",x:x,y:y-20,allColors:!0,fixed:!0,size:"small",color:thiz.config.color(d[thiz.config.label]),fontfamily:"Helvetica Neue",fontweight:200,fontsize:"15px",data:data,width:maxWidth,max_width:maxWidth,mouseevents:!1,arrow:!0,align:"bottom center",anchor:"top left",title:thiz.config.format.text(d[thiz.config.label])};d3plus.tooltip.create(config)},BubbleBuilder.prototype.buildNodes=function(data){for(var thiz=this,d=this.groupingData(data),i=0;i<d.length;i++)d[i].value=d[i][thiz.config.size];return{children:d}},BubbleBuilder.prototype.roolup=function(v,sample){var data={},thiz=this;for(var attr in sample)attr==this.config.time?data[attr]=v.map(function(d){return-1==thiz.timeArray.indexOf(d[attr])&&thiz.timeArray.push(d[attr]),d[attr]}):attr==this.config.label?data[attr]=v[0][attr]:"number"==typeof sample[attr]?data[attr]=d3.sum(v,function(d){return d[attr]}):data[attr]=v.map(function(d){return d[attr]});return data},BubbleBuilder.prototype.groupingData=function(data){var thiz=this,sampleObj=null,tmp=data.filter(function(d){return 0==thiz.timeSelection.length||thiz.timeSelection.indexOf(d[thiz.config.time])>=0}),filters=d3.nest().key(function(d){return sampleObj=d,d[thiz.config.label]}).rollup(function(v){return thiz.roolup(v,sampleObj)}).entries(tmp);return filters.map(function(d){return d.values})},BubbleBuilder.prototype.onChange=function(){var data=$.extend([],this.dataArray,!0);this.builder(data),this.wrapText()},BubbleBuilder.prototype.timeline=function(){var ul=d3.select("#"+this.footerId).append("ul").attr("class","timeline").attr("tabindex",1),thiz=this,time=this.timeArray.sort().map(function(d){var data={time:d,_selected:!0};return data}),li=ul.selectAll("li").data(time).enter().append("li").attr("class","entry").classed("selected",function(d){return d._selected}).append("a").text(function(d){return d.time});this.selectable(ul,li,function(e){var selections=[];ul.selectAll("li").classed("selected",function(d){return d._selected&&selections.push(d),d._selected}),thiz.timeSelection=selections.map(function(d){return d.time}),thiz.onChange(),thiz.trigger("timechange",thiz.timeSelection)})},BubbleBuilder.prototype.sizeToggle=function(){var $footer=$("#"+this.footerId),$toogle=$("<div></div>");$toogle.addClass("bubble-toogle"),$toogle.attr("id",this.footerId+"-toogle"),$footer.append($toogle);var thiz=this;d3plus.form().data(this.config.toggle.size).title(this.config.toggle.title).container("#"+this.footerId+"-toogle").id("value").text("text").type("toggle").draw();$footer.find(".d3plus_toggle").on("click",function(d){var $target=$(this)[0],data=$target.__data__;"undefined"!=typeof data&&(thiz.config.size=data.value,thiz.onChange())})},BubbleChart.prototype.data=function(data){this.builder.data(data)},BubbleChart.prototype.on=function(event,handler){this.builder.event[event]=handler};